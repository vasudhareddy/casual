import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import jakarta.xml.bind.JAXBContext;
import jakarta.xml.bind.JAXBException;
import jakarta.xml.soap.*;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.mockito.junit.jupiter.MockitoExtension;
import java.io.ByteArrayOutputStream;
import java.nio.charset.StandardCharsets;

@ExtendWith(MockitoExtension.class)
public class SOAPServiceTest {

    @InjectMocks
    private SOAPService soapService;

    @Mock
    private SOAPMessage mockSoapMessage;

    @Mock
    private SaajSoapMessage mockSaajSoapMessage;

    @Mock
    private SOAPConnection mockSoapConnection;

    @Mock
    private SOAPConnectionFactory mockSoapConnectionFactory;

    @Mock
    private ByteArrayOutputStream mockOutputStream;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void testSendSOAPRequest_Success() throws Exception {
        // Arrange
        LoanSearchMwsRequest requestObject = new LoanSearchMwsRequest();
        LoanSearchRead expectedResponse = new LoanSearchRead();
        String endpointUrl = "http://mock.url";
        String authToken = "mockToken";
        String soapAction = "mockAction";

        when(mockSoapMessage.getSOAPBody()).thenReturn(mock(SOAPBody.class));
        when(mockSaajSoapMessage.getSaajMessage()).thenReturn(mockSoapMessage);
        when(mockSoapConnection.call(any(SOAPMessage.class), eq(endpointUrl))).thenReturn(mockSoapMessage);
        when(mockSoapConnectionFactory.createConnection()).thenReturn(mockSoapConnection);
        when(mockSoapMessage.getSOAPBody()).thenReturn(mock(SOAPBody.class));

        // Act
        LoanSearchRead actualResponse = soapService.sendSOAPRequest(requestObject, LoanSearchMwsRequest.class, LoanSearchRead.class, endpointUrl, authToken, soapAction);

        // Assert
        assertNotNull(actualResponse);
    }

    @Test
    void testSendSOAPRequest_SOAPException() throws Exception {
        // Arrange
        LoanSearchMwsRequest requestObject = new LoanSearchMwsRequest();
        String endpointUrl = "http://mock.url";
        String authToken = "mockToken";
        String soapAction = "mockAction";

        when(mockSoapConnection.call(any(SOAPMessage.class), eq(endpointUrl))).thenThrow(new SOAPException("SOAP Error"));

        // Act & Assert
        assertThrows(SoapServiceException.class, () -> 
            soapService.sendSOAPRequest(requestObject, LoanSearchMwsRequest.class, LoanSearchRead.class, endpointUrl, authToken, soapAction)
        );
    }

    @Test
    void testCreateSOAPMessage_Success() throws Exception {
        // Arrange
        LoanSearchMwsRequest requestObject = new LoanSearchMwsRequest();
        SOAPMessage mockSoapMessage = mock(SOAPMessage.class);
        SOAPBody mockSoapBody = mock(SOAPBody.class);

        when(mockSoapMessage.getSOAPBody()).thenReturn(mockSoapBody);

        // Act
        SOAPMessage result = soapService.createSOAPMessage(requestObject, LoanSearchMwsRequest.class);

        // Assert
        assertNotNull(result);
    }

    @Test
    void testCreateSOAPMessage_JAXBException() throws Exception {
        // Arrange
        LoanSearchMwsRequest requestObject = new LoanSearchMwsRequest();

        // Simulate JAXBException
        doThrow(new JAXBException("JAXB Error")).when(mockSoapMessage).getSOAPBody();

        // Act & Assert
        assertThrows(SoapServiceException.class, () -> soapService.createSOAPMessage(requestObject, LoanSearchMwsRequest.class));
    }

    @Test
    void testSendSOAPMessage_Success() throws Exception {
        // Arrange
        String endpointUrl = "http://mock.url";
        String authToken = "mockToken";
        when(mockSoapConnection.call(any(SOAPMessage.class), eq(endpointUrl))).thenReturn(mockSoapMessage);

        // Act
        SOAPMessage response = soapService.sendSOAPMessage(mockSaajSoapMessage, endpointUrl, authToken);

        // Assert
        assertNotNull(response);
    }

    @Test
    void testSendSOAPMessage_SOAPException() throws Exception {
        // Arrange
        String endpointUrl = "http://mock.url";
        String authToken = "mockToken";
        when(mockSoapConnection.call(any(SOAPMessage.class), eq(endpointUrl))).thenThrow(new SOAPException("SOAP Connection Error"));

        // Act & Assert
        assertThrows(SoapServiceException.class, () -> soapService.sendSOAPMessage(mockSaajSoapMessage, endpointUrl, authToken));
    }

    @Test
    void testConvertSOAPToJAXB_Success() throws Exception {
        // Arrange
        LoanSearchRead expectedResponse = new LoanSearchRead();
        SOAPMessage mockSoapMessage = mock(SOAPMessage.class);
        SOAPBody mockSoapBody = mock(SOAPBody.class);

        when(mockSoapMessage.getSOAPBody()).thenReturn(mockSoapBody);

        // Act
        LoanSearchRead actualResponse = soapService.convertSOAPToJAXB(mockSoapMessage, LoanSearchRead.class);

        // Assert
        assertNotNull(actualResponse);
    }

    @Test
    void testConvertSOAPToJAXB_JAXBException() throws Exception {
        // Arrange
        SOAPMessage mockSoapMessage = mock(SOAPMessage.class);

        // Simulate JAXBException
        doThrow(new JAXBException("JAXB Parsing Error")).when(mockSoapMessage).getSOAPBody();

        // Act & Assert
        assertThrows(SoapServiceException.class, () -> soapService.convertSOAPToJAXB(mockSoapMessage, LoanSearchRead.class));
    }

    @Test
    void testGetSOAPMessageAsString_Success() throws Exception {
        // Arrange
        when(mockSoapMessage.writeTo(any(ByteArrayOutputStream.class))).thenAnswer(invocation -> {
            ByteArrayOutputStream stream = invocation.getArgument(0);
            stream.write("Mock SOAP Message".getBytes(StandardCharsets.UTF_8));
            return null;
        });

        // Act
        String result = soapService.getSOAPMessageAsString(mockSoapMessage);

        // Assert
        assertNotNull(result);
        assertEquals("Mock SOAP Message", result);
    }

    @Test
    void testGetSOAPMessageAsString_Exception() throws Exception {
        // Arrange
        doThrow(new SOAPException("SOAP Write Error")).when(mockSoapMessage).writeTo(any(ByteArrayOutputStream.class));

        // Act & Assert
        assertThrows(SoapServiceException.class, () -> soapService.getSOAPMessageAsString(mockSoapMessage));
    }
}
